# Killswitch — руководство пользователя (RU)

KILLSWITCH
Руководство пользователя
Автоматическая защита криптопортфеля
Binance • Bybit • Bitget
Spot + Futures

Содержание

## I. ВВЕДЕНИЕ


## II. КАК ЭТО РАБОТАЕТ


## III. ЧТО УМЕЕТ СИСТЕМА


## IV. НАСТРОЙКА ПОД СВОИ ЗАДАЧИ


## V. ЗАПУСК И ТЕСТИРОВАНИЕ


## VI. ПРАКТИЧЕСКИЕ СЦЕНАРИИ


## VII. МОНИТОРИНГ И ДИАГНОСТИКА


## VIII. РЕШЕНИЕ ПРОБЛЕМ


## IX. FAQ


## X. ПРИЛОЖЕНИЯ



## I. ВВЕДЕНИЕ


### 1. Что это и зачем

Killswitch — это автоматическая система аварийного управления риском для криптовалютного портфеля. Её главная задача: быстро сократить риск при сильных рыночных просадках — закрыть фьючерсные позиции и распродать спотовые активы, прежде чем убыток станет неконтролируемым.
Какие проблемы решает
Внезапные обвалы и каскады ликвидаций, когда «дотянуться руками» физически невозможно
Управление позициями на разных биржах и разных типах счетов (спот/фьючерсы) одновременно
Риск «ещё чуть-чуть подожду» — система действует по заранее заданным правилам, без эмоций
Операционные ошибки в панике: случайно перепутали аккаунт, рынок, сторону, объём
Что Killswitch НЕ делает


### 2. Ключевые возможности

Работает одновременно на трёх биржах: Binance, Bybit, Bitget
Защищает и фьючерсные позиции, и спотовые активы
Два уровня защиты: раннее предупреждение (Tier A) и полное закрытие (Tier B)
Автоматически конвертирует все активы в USDT при срабатывании
Гибкая настройка порогов и временных окон под любую стратегию
Защита от ложных срабатываний через систему подтверждений
Режим тестирования (dry-run) для безопасной отладки

### 3. Критические ограничения

Важно понимать, что Killswitch — это инструмент снижения риска, а не магическая защита. Система работает в рамках технических возможностей бирж и имеет ряд ограничений:


## II. КАК ЭТО РАБОТАЕТ


### 4. Общая логика: простыми словами

Представьте, что у вас есть помощник, который каждую минуту проверяет ваш портфель и сравнивает текущий баланс с недавним максимумом. Если падение превысило заданный порог — помощник автоматически закрывает позиции или продаёт активы.
Шаг за шагом
Каждую минуту (или с другим интервалом) система опрашивает биржи
Получает текущий баланс каждого счёта (фьючерсы и спот отдельно)
Записывает значение в базу данных (SQLite)
Накапливается история для расчёта просадок
Вычисляет просадку (drawdown) в нескольких временных окнах
Например: за 1 минуту, 5 минут, 15 минут, 1 час
Сравнивает просадку с настроенными порогами
Tier A (раннее предупреждение) и Tier B (полная защита) проверяются независимо
Если порог пробит — требует подтверждение
Например, 3 проверки подряд должны показать превышение порога
Выполняет действие
Закрывает фьючерсы или продаёт спот (зависит от настроек)
Включает паузу (cooldown)
На заданное время (30-360 минут) система «молчит», чтобы не дёргать портфель


### 5. Что такое «просадка» и когда система срабатывает

Просадка (drawdown) — это падение вашего баланса от недавнего локального максимума. Система НЕ реагирует на абсолютную цену активов, а следит за изменением ВАШЕГО капитала.
Пример расчёта
Важно: система ищет НАИХУДШЕЕ окно. Если хотя бы одно окно превысило порог — срабатывает триггер.
Временные окна
Вы можете настроить несколько окон одновременно. Например:
1 минута — для очень быстрых обвалов
5 минут — для умеренных движений
15 минут — для подтверждения тренда
1 час — для долгосрочных просадок
Система проверяет ВСЕ окна и срабатывает, если хотя бы одно превысило порог.


### 6. Tier A и Tier B: два уровня защиты

Система использует двухуровневую защиту — это позволяет реагировать по-разному на разную силу падения.
Tier A — раннее предупреждение

Примеры действий Tier A:
CLOSE_LONGS_ONLY — закрыть только лонги на фьючерсах, оставить шорты
SELL_BLACKLIST_ONLY — продать только указанные монеты (мемкоины, низколиквидные альты)
Tier B — полная защита

Примеры действий Tier B:
CLOSE_ALL_POSITIONS — закрыть ВСЕ фьючерсные позиции (лонги и шорты)
SELL_ALL_NON_USDT — продать ВСЁ кроме USDT/USDC/DAI


### 7. Подтверждение (защита от ложных сигналов)

Крипторынок волатилен — бывают резкие «шпильки» на графике, которые моментально восстанавливаются. Чтобы не закрывать позиции на каждом таком движении, система использует подтверждение.
Механизм confirm_consecutive
Параметр confirm_consecutive задаёт, сколько проверок ПОДРЯД должны показать превышение порога.
Пример:
poll_seconds: 60 (проверка каждую минуту)
confirm_consecutive: 3
Порог Tier A: 2% за 5 минут
Что произойдёт:
10:00 — просадка 2.5% → счётчик = 1
10:01 — просадка 2.8% → счётчик = 2
10:02 — просадка 3.1% → счётчик = 3 → ТРИГГЕР
Если на 10:01 просадка опустилась ниже 2%, счётчик сбросится в 0.
Как выбрать значение


### 8. Пауза (cooldown): почему важна

После того как система выполнила действие (закрыла позиции или продала активы), она делает паузу на заданное время. Это предотвращает «дрожание» — постоянное открытие-закрытие позиций.
Как это работает
Tier A сработал в 10:00, cooldown = 60 минут
До 11:00 Tier A «молчит» — не будет повторных срабатываний
Tier B при этом может сработать независимо (у него своя пауза)
Рекомендуемые значения


## III. ЧТО УМЕЕТ СИСТЕМА


### 9. Фьючерсы: два режима

Для фьючерсных позиций система поддерживает два режима закрытия. Выбор режима зависит от вашей стратегии и рыночной ситуации.
CLOSE_LONGS_ONLY — закрыть только лонги
Когда использовать:
Рынок падает, и вы хотите убрать риск ликвидации по лонгам
У вас есть шорты как хедж — их оставляем, они в плюсе
Вы хотите остаться в игре, но снизить экспозицию
Что происходит:
Система находит все открытые лонг-позиции
Закрывает их рыночными ордерами (market order) с флагом reduceOnly
Шорт-позиции не трогает
CLOSE_ALL_POSITIONS — закрыть всё
Когда использовать:
Паника на рынке, непредсказуемые движения
Хотите полностью выйти в кэш
Не уверены в направлении рынка
Что происходит:
Система находит ВСЕ открытые позиции (лонги и шорты)
Закрывает их рыночными ордерами
Портфель переходит в чистый кэш


### 10. Спот: два режима

Для спотовых активов система поддерживает выборочную или полную распродажу. Это позволяет гибко реагировать на разную силу падения.
SELL_BLACKLIST_ONLY_KEEP_STABLES — продать список монет
Когда использовать:
Первые признаки слабости рынка
Хотите избавиться от «мусора», но оставить качественные активы
Tier A — раннее предупреждение
Что происходит:
Система продаёт ТОЛЬКО монеты из списка blacklist
Никогда не трогает stables_keep (USDT, USDC, DAI, FDUSD)
Остальные активы (BTC, ETH и т.д.) остаются нетронутыми
Пример blacklist:
blacklist: ["DOGE", "SHIB", "PEPE", "BONK", "FLOKI"]
SELL_ALL_NON_USDT_KEEP_STABLES — продать всё кроме стейблов
Когда использовать:
Реальная паника на рынке
Хотите полностью перейти в стейблы
Tier B — полная защита
Что происходит:
Система продаёт ВСЁ: BTC, ETH, альты — всё что не в stables_keep
Оставляет только USDT, USDC, DAI, FDUSD
Портфель полностью в стейблах


### 11. Как система продаёт спот

Не все монеты имеют прямую пару с USDT. Система использует интеллектуальный роутинг через промежуточные активы.
Трёхуровневый роутинг
Путь 1: Прямая пара COIN/USDT
Если существует пара DOGE/USDT → продаём напрямую
Самый быстрый и дешёвый вариант
Путь 2: Через BTC (COIN/BTC → BTC/USDT)
Продаём COIN за BTC (например, DOGE/BTC)
СРАЗУ продаём ВЕСЬ полученный BTC за USDT
Путь 3: Через ETH (COIN/ETH → ETH/USDT)
Аналогично: COIN → ETH, затем ETH → USDT
Минимальный размер ордера
Биржи требуют минимальную сумму ордера (обычно 5-10 USDT). Система автоматически фильтрует «пыль»:
Если оценочная стоимость актива < 10 USDT → пропускается
Это предотвращает отклонение ордеров биржей
Мелкие хвосты останутся в портфеле — это нормально


## IV. НАСТРОЙКА ПОД СВОИ ЗАДАЧИ


### 12. Структура config.yaml

Вся настройка системы осуществляется через один файл — config.yaml. Он имеет четырёхуровневую иерархию:
Глобальные параметры
Частота опроса, режим тестирования, список стейблов
Настройки бирж
API ключи, включение/отключение биржи
Настройки счетов
Futures и Spot — включаются отдельно
Настройки уровней защиты
Tier A и Tier B с индивидуальными порогами


### 13. Главные параметры

Эти параметры находятся в самом начале config.yaml и применяются глобально ко всей системе.

Пример:
poll_seconds: 60 state_db: "./killswitch.sqlite" dry_run: true stables_keep: ["USDT", "USDC", "DAI", "FDUSD"]


### 14. Подключение бирж

Для каждой биржи нужно создать API ключи и безопасно их сохранить.
Создание API ключей
Binance:
Заходим на binance.com → Аккаунт → API Management
Создаём ключ с правами: Read Info + Spot & Margin Trading
НЕ ДАВАТЬ права: Withdraw, Transfer, Sub-accounts
Bybit:
bybit.com → API Management → Create New Key
Права: Contract + Spot → Read + Trade
Bitget:
bitget.com → API Management → Create API
ВАЖНО: Bitget требует Passphrase — сохраните его!
Безопасное хранение ключей
Пример настройки в config.yaml:
binance:   enabled: true   api_key_env: "BINANCE_API_KEY"   api_secret_env: "BINANCE_API_SECRET"
Экспорт переменных окружения (Linux/Mac):
export BINANCE_API_KEY="ваш_ключ" export BINANCE_API_SECRET="ваш_секрет" export BYBIT_API_KEY="..." export BYBIT_API_SECRET="..." export BITGET_API_KEY="..." export BITGET_API_SECRET="..." export BITGET_PASSWORD="..."


### 15. Временные окна (windows)

Временные окна определяют, за какой период считать просадку. Можно использовать несколько окон одновременно.
Форматы записи
Как выбрать оптимальные окна
Короткие окна (1-5 минут):
Плюсы: быстрая реакция на обвалы
Минусы: больше ложных срабатываний на волатильности
Подходит для: агрессивных стратегий, высоколиквидных активов
Средние окна (15-30 минут):
Плюсы: баланс скорости и точности
Минусы: может пропустить очень быстрые обвалы
Подходит для: большинства сценариев
Длинные окна (1-4 часа):
Плюсы: реакция только на устойчивые тренды
Минусы: медленная реакция, можно потерять больше
Подходит для: консервативных стратегий, долгосрочных позиций


### 16. Пороги срабатывания (thresholds)

Пороги определяют, при какой просадке сработает триггер. Это самый важный параметр настройки.
Формат записи
Пороги задаются как словарь: временное окно → процент просадки
thresholds:   "1": 0.012    # 1.2% за 1 минуту   "5": 0.020    # 2.0% за 5 минут   "15m": 0.040  # 4.0% за 15 минут   "1h": 0.080   # 8.0% за 1 час
Система сработает, если ХОТЯ БЫ ОДНО окно превысило порог.
Таблица рекомендуемых значений
Эти значения — отправная точка. Калибруйте под свою волатильность:


Как калибровать пороги
Запустите в dry_run на 2-3 дня
Посмотрите, как часто срабатывают триггеры
Анализируйте логи
Если срабатывает слишком часто → повысьте пороги
Если не срабатывает при реальных падениях → снизьте
Учитывайте волатильность актива
BTC/ETH: можно более агрессивные пороги
Альты: нужны более высокие пороги (больше шума)
Постепенно подстраивайте
Не меняйте радикально — делайте шаги по 0.5-1%


### 17. Подтверждение (confirm_consecutive)

Этот параметр задаёт, сколько проверок ПОДРЯД должны показать превышение порога перед выполнением действия.

Пример:
tier_a:   thresholds: { "5": 0.02 }   confirm_consecutive: 2    # При poll_seconds: 60 # Требуется: 2 проверки подряд × 60 секунд = 2 минуты подтверждения


### 18. Время паузы (cooldown_min)

После выполнения действия система делает паузу, чтобы не спамить закрытиями-открытиями позиций.
Рекомендуемые значения

Логика выбора:
Tier A — частичные действия, можно срабатывать чаще
Tier B — полное закрытие, нужно дать рынку время успокоиться
Cooldown Tier B должен быть значительно больше Tier A
Пример:
tier_a:   cooldown_min: 45    # 45 минут паузы    tier_b:   cooldown_min: 240   # 4 часа паузы


### 19. Список монет для спота (blacklist)

Blacklist используется в режиме SELL_BLACKLIST_ONLY — система продаёт только указанные монеты.
Какие монеты включать
Мемкоины с высокой волатильностью (DOGE, SHIB, PEPE)
Низколиквидные альты, которые падают сильнее рынка
Спекулятивные позиции, которые вы готовы сбросить первыми
Монеты, в которых вы не уверены долгосрочно
Пример:
tier_a:   mode: "SELL_BLACKLIST_ONLY_KEEP_STABLES"   blacklist: ["DOGE", "SHIB", "PEPE", "BONK", "FLOKI"]
Tier A vs Tier B
Tier A — используйте blacklist:
Продаёт только рисковые монеты
Оставляет качественные активы (BTC, ETH)
Логика: «сбросить мусор, остаться в игре»
Tier B — обычно без blacklist:
tier_b:   mode: "SELL_ALL_NON_USDT_KEEP_STABLES"   # blacklist не нужен — продаём всё
Продаёт ВСЁ кроме стейблов
Логика: «полный выход в безопасность»


## V. ЗАПУСК И ТЕСТИРОВАНИЕ


### 20. Подготовка к запуску

Перед первым запуском необходимо установить зависимости и настроить окружение.
Установка Python и библиотек
Требования:
Python 3.8 или новее
Библиотеки: ccxt, pyyaml, tenacity
Установка:
# Проверка версии Python python3 --version  # Установка библиотек pip install ccxt pyyaml tenacity  # Или через requirements.txt (если есть) pip install -r requirements.txt
Настройка переменных окружения
Создайте файл для экспорта ключей (НЕ КОММИТЬТЕ ЕГО В GIT!):
# ~/.killswitch_env export BINANCE_API_KEY="ваш_ключ" export BINANCE_API_SECRET="ваш_секрет" export BYBIT_API_KEY="..." export BYBIT_API_SECRET="..." export BITGET_API_KEY="..." export BITGET_API_SECRET="..." export BITGET_PASSWORD="..."
Загрузка перед запуском:
source ~/.killswitch_env
Проверка config.yaml


### 21. Режим тестирования (dry_run)

Dry-run — это обязательный этап. Система анализирует портфель, принимает решения, но НЕ отправляет реальные ордера.
Как это работает
Система подключается к биржам и получает реальные данные
Записывает историю балансов в базу данных
Вычисляет просадки и принимает решения
Логирует что БЫЛО БЫ сделано, но не делает
В логах видно: «DRY RUN: would close position...»
Минимальная длительность
Включение dry_run
В config.yaml:
dry_run: true  # ОБЯЗАТЕЛЬНО для первого запуска


### 22. Первый запуск

Пошаговая инструкция для первого безопасного запуска.
Загрузите переменные окружения
source ~/.killswitch_env
Проверьте что dry_run: true
grep "dry_run" config.yaml # Должно быть: dry_run: true
Запустите систему
python3 killswitch.py --config config.yaml
Следите за выводом
Должны появляться регулярные сообщения о проверках
Что вы увидите
Нормальный вывод при запуске:
[2025-01-25 10:00:00] Starting Killswitch v2.0 [2025-01-25 10:00:00] DRY RUN MODE: No orders will be placed [2025-01-25 10:00:01] Connecting to binance... [2025-01-25 10:00:01] ✓ Connected to binance_futures [2025-01-25 10:00:02] Checking scope binance_futures... [2025-01-25 10:00:02] Equity: 10245.67 USDT [2025-01-25 10:00:02] No trigger (DD below thresholds)


### 23. Что смотреть во время теста

В течение 24-48 часов dry-run мониторьте следующие метрики.
Чек-лист наблюдения
Подключение к биржам:
Нет постоянных ошибок «Connection failed»
Балансы определяются корректно (не 0, не NaN)
Каждый scope проверяется регулярно
База данных:
# Проверка что история накапливается sqlite3 killswitch.sqlite "SELECT COUNT(*) FROM snapshots" # Должно расти со временем  # Проверка последних записей sqlite3 killswitch.sqlite "SELECT datetime(ts,'unixepoch'), equity FROM snapshots ORDER BY ts DESC LIMIT 10"
Решения:
При движении рынка вниз — система должна логировать вычисление просадок
Если пороги пробиты — должно быть сообщение о DRY RUN действии
Cooldown должен корректно устанавливаться и сбрасываться
Ошибки:
Случайные сетевые ошибки — нормально (будут retry)
Постоянные ошибки «Invalid API key» — проблема с ключами
Ошибки «Insufficient balance» в dry-run — это ОК (не реальная торговля)
Красные флаги (требуют внимания)


### 24. Переход в боевой режим

После успешного dry-run тестирования можно переходить к реальной торговле. Делайте это поэтапно!
Фаза 1: Одна биржа, один scope
Выберите наименее критичный scope
Например, Bybit Futures с минимальной позицией
Измените dry_run на false
# В config.yaml dry_run: false
Перезапустите систему
# Остановите старый процесс (Ctrl+C) # Перезапустите python3 killswitch.py --config config.yaml
Контролируйте первые 48 часов
Проверяйте каждые 4-6 часов
Убедитесь что система работает корректно
Фаза 2: Постепенное расширение
После успешной работы одного scope:
Включите второй scope (например, Binance Futures)
Снова 48 часов контроля
Затем третий scope и так далее
Не включайте все биржи одновременно!
Фаза 3: Мониторинг первой недели


## VI. ПРАКТИЧЕСКИЕ СЦЕНАРИИ

Рассмотрим конкретные примеры настройки под разные задачи и стратегии.

### 25. Сценарий 1: Консервативная защита капитала

Цель: защитить портфель от сильных обвалов (>10%), но не реагировать на обычную рыночную волатильность.
Характеристики стратегии
Минимум ложных срабатываний
Реакция только на реальные кризисы
Длинные временные окна
Высокие пороги
Строгое подтверждение
Настройки
futures:
enabled: true
windows: [15, 60]  # 15 минут и 1 час
tier_a:
thresholds:       "15": 0.035  # 3.5% за 15 минут
"60": 0.070  # 7% за час
confirm_consecutive: 3
mode: "CLOSE_LONGS_ONLY"
cooldown_min: 90
tier_b:
thresholds:       "15": 0.070  # 7% за 15 минут
"60": 0.120  # 12% за час
confirm_consecutive: 3
mode: "CLOSE_ALL_POSITIONS"
cooldown_min: 360
spot:   enabled: true
windows: [60]
tier_a:     thresholds: { "60": 0.12 }  # 12% за час
mode: "SELL_BLACKLIST_ONLY_KEEP_STABLES"
blacklist: ["DOGE", "SHIB"]
cooldown_min: 120
tier_b:     thresholds: { "60": 0.20 }
# 20% за час     mode: "SELL_ALL_NON_USDT_KEEP_STABLES"
cooldown_min: 480
Ожидаемое поведение
При падении 5% за 10 минут — система молчит (не достиг порога)
При падении 8% за 20 минут — Tier A закроет лонги (после 3 подтверждений)
При крахе 15% за 30 минут — Tier B закроет всё
Минимум ложных тревог на обычной волатильности


### 26. Сценарий 2: Агрессивный fast-exit

Цель: при первых признаках обвала — моментально выйти из позиций.
Характеристики стратегии
Максимальная скорость реакции
Короткие временные окна
Низкие пороги
Минимальное подтверждение
Риск: больше ложных срабатываний
Настройки
futures:   enabled: true   windows: [1, 5, 15]      tier_a:     thresholds:       "1": 0.015   # 1.5% за минуту       "5": 0.025   # 2.5% за 5 минут     confirm_consecutive: 1  # Моментальная реакция     mode: "CLOSE_LONGS_ONLY"     cooldown_min: 30      tier_b:     thresholds:       "5": 0.035   # 3.5% за 5 минут       "15": 0.050  # 5% за 15 минут     confirm_consecutive: 2     mode: "CLOSE_ALL_POSITIONS"     cooldown_min: 120  spot:   enabled: true   windows: [5, 15]      tier_a:     thresholds: { "5": 0.04 }  # 4% за 5 минут     mode: "SELL_BLACKLIST_ONLY_KEEP_STABLES"     blacklist: ["DOGE", "SHIB", "PEPE"]     cooldown_min: 30      tier_b:     thresholds: { "15": 0.08 }  # 8% за 15 минут     mode: "SELL_ALL_NON_USDT_KEEP_STABLES"     cooldown_min: 180
Ожидаемое поведение
При падении 2% за 1 минуту — Tier A срабатывает СРАЗУ
При падении 4% за 5 минут — Tier B закроет всё (через 2 минуты)
Частые срабатывания на волатильности — это нормально для агрессивной стратегии
Лучшая защита от flash-crash


### 27. Сценарий 3: Защита мультибиржевого портфеля

Цель: единая защита портфеля, распределённого на Binance + Bybit + Bitget.
Стратегия внедрения
Включайте биржи поэтапно
Сначала одна биржа в dry-run → проверка → LIVE
Затем вторая, третья
Используйте одинаковые пороги
Это обеспечит единую логику защиты
Учитывайте особенности бирж
Bitget может быть менее стабилен → чуть выше пороги
Пример настройки
# Одинаковые настройки для всех бирж
binance:
enabled: true
accounts:     futures:
windows: [5, 15]
tier_a: { thresholds: {"5": 0.02}, mode: "CLOSE_LONGS_ONLY", cooldown_min: 60 }
tier_b: { thresholds: {"15": 0.05},
mode: "CLOSE_ALL_POSITIONS", cooldown_min: 240 }

bybit:
enabled: true
accounts:
futures:
windows: [5, 15]
tier_a: { thresholds: {"5": 0.02},
mode: "CLOSE_LONGS_ONLY", cooldown_min: 60 }
tier_b: { thresholds: {"15": 0.05},
mode: "CLOSE_ALL_POSITIONS", cooldown_min: 240 }
bitget:
enabled: true
accounts:     futures:
windows: [5, 15]       # Чуть выше пороги из-за менее стабильного API
tier_a: { thresholds: {"5": 0.025},
mode: "CLOSE_LONGS_ONLY", cooldown_min: 60 }
tier_b: { thresholds: {"15": 0.06},
mode: "CLOSE_ALL_POSITIONS", cooldown_min: 240 }
Ожидаемое поведение
При обвале разные биржи закроются независимо по своим просадкам
Если одна биржа «легла» — остальные всё равно защитятся
Единая логика упрощает мониторинг


### 28. Сценарий 4: Только фьючерсы

Цель: спот держим долгосрок (HODL), фьючерсы защищаем активно.
Настройки
futures:   enabled: true   windows: [1, 5, 15]      tier_a:     thresholds:       "1": 0.012       "5": 0.020     mode: "CLOSE_LONGS_ONLY"     cooldown_min: 45      tier_b:     thresholds:       "15": 0.045     mode: "CLOSE_ALL_POSITIONS"     cooldown_min: 180  spot:   enabled: false  # Спот не трогаем
Логика
Спот — долгосрочные позиции, держим через волатильность
Фьючерсы — активная торговля, нужна защита от ликвидаций
Tier A защитит от маржин-колла на лонгах
Tier B — аварийный выход при настоящей панике


### 29. Сценарий 5: Селективная очистка спота

Цель: при первых признаках падения — сбросить мусор (мемкоины), при панике — полностью в USDT.
Настройки
spot:   enabled: true   windows: [15, 60]      tier_a:     thresholds: { "15": 0.08 }  # 8% за 15 минут     mode: "SELL_BLACKLIST_ONLY_KEEP_STABLES"     blacklist: ["DOGE", "SHIB", "PEPE", "BONK", "FLOKI", "WIF"]     confirm_consecutive: 2     cooldown_min: 60      tier_b:     thresholds: { "60": 0.15 }  # 15% за час     mode: "SELL_ALL_NON_USDT_KEEP_STABLES"     confirm_consecutive: 3     cooldown_min: 360
Двухуровневая логика
Tier A — «лёгкая чистка»:
Падение 8-10% за 15 минут
Продаём только мемкоины из blacklist
Оставляем BTC, ETH, качественные альты
Cooldown 60 минут — можем повторить
Tier B — «полная эвакуация»:
Падение 15%+ за час
Продаём ВСЁ кроме USDT/USDC
Включая BTC, ETH
Cooldown 6 часов — серьёзное решение

## VII. МОНИТОРИНГ И ДИАГНОСТИКА


### 30. Как понять, что система работает

Основные признаки нормальной работы системы.
Регулярные проверки в консоли
Каждые poll_seconds должны появляться сообщения:
[2025-01-25 14:23:15] Checking scope binance_futures... [2025-01-25 14:23:15] Equity: 10456.23 USDT [2025-01-25 14:23:15] DD[5m]=0.8% DD[15m]=1.2% - No trigger [2025-01-25 14:23:15] Checking scope bybit_spot... [2025-01-25 14:23:16] Equity: 5234.89 USDT [2025-01-25 14:23:16] DD[60m]=2.1% - No trigger
База данных растёт
Проверка накопления истории:
# Количество записей должно расти sqlite3 killswitch.sqlite "SELECT COUNT(*) FROM snapshots" # Пример: через час при poll_seconds=60 должно быть ~60 записей на scope  # Последние записи sqlite3 killswitch.sqlite "SELECT datetime(ts,'unixepoch'), exchange, account, equity FROM snapshots ORDER BY ts DESC LIMIT 5"
Реакция на движения рынка
При падении рынка — в логах должны появляться вычисления просадок
DD (drawdown) должны увеличиваться при падении
При приближении к порогу — должны быть сообщения «close to threshold»
При пробитии порога — «TIER X TRIGGERED»


### 31. Типичные сообщения в логах

Научитесь различать нормальные сообщения от критичных.
Нормальная работа
Предупреждения (жёлтые флаги)
Критичные события (красные флаги)
Ошибки (требуют внимания)


### 32. Базовые проверки через SQLite

Полезные команды для диагностики состояния системы.
Проверка истории балансов
# Общее количество снимков sqlite3 killswitch.sqlite "SELECT COUNT(*) FROM snapshots"  # Снимки за последние 24 часа sqlite3 killswitch.sqlite "SELECT COUNT(*) FROM snapshots WHERE ts > unixepoch('now') - 86400"  # График equity за последний час (Binance Futures) sqlite3 killswitch.sqlite " SELECT    datetime(ts, 'unixepoch', 'localtime') as time,   equity  FROM snapshots  WHERE exchange='binance' AND account='futures'   AND ts > unixepoch('now') - 3600 ORDER BY ts ASC"
Проверка выполненных действий
# Все действия за всё время sqlite3 killswitch.sqlite "SELECT * FROM actions ORDER BY ts DESC"  # Последние 10 действий sqlite3 killswitch.sqlite " SELECT    datetime(ts, 'unixepoch', 'localtime') as time,   key,   details FROM actions  ORDER BY ts DESC  LIMIT 10"
Проверка активных cooldown
# Текущие паузы sqlite3 killswitch.sqlite " SELECT    scope,   tier,   datetime(until, 'unixepoch', 'localtime') as expires FROM cooldowns  WHERE until > unixepoch('now')"
Сброс cooldown вручную (emergency)
# Сбросить cooldown для конкретного scope и tier sqlite3 killswitch.sqlite "DELETE FROM cooldowns WHERE scope='binance_futures' AND tier='A'"  # Сбросить ВСЕ cooldown (опасно!) sqlite3 killswitch.sqlite "DELETE FROM cooldowns"


### 33. Настройка алертов и уведомлений

Система может отправлять уведомления при важных событиях.
Что алертить
Критичные события (обязательно):
Tier A или Tier B сработал — уведомление с деталями
Ошибки API продолжаются > 10 минут
Circuit breaker активирован
Equity упала > 20% от максимума
Информационные (опционально):
Система запущена/остановлена
Cooldown активирован/истёк
Частичное закрытие позиций
Способы уведомлений
Telegram (рекомендуется):
Быстрые push-уведомления
Можно отправлять скриншоты логов
Настройка через Telegram Bot API
Email:
Подходит для некритичных уведомлений
Задержка в доставке
Discord Webhook:
Если используете Discord для трейдинга
Удобно для team мониторинга


## VIII. РЕШЕНИЕ ПРОБЛЕМ


### 34. Проблема: Биржа не отвечает

Признаки:
Постоянные ошибки «Connection timeout»
«RETRY: Network error» каждую минуту
Equity не обновляется
Причины:
Проблемы с интернетом на вашей стороне
Биржа в maintenance (технические работы)
VPN блокирует доступ к бирже
IP адрес заблокирован биржей
Rate limit из-за слишком частых запросов
Решения:
Проверьте интернет
ping 8.8.8.8 curl https://api.binance.com/api/v3/ping
Проверьте статус биржи
Зайдите на сайт биржи через браузер
Проверьте Twitter биржи на сообщения о maintenance
Проверьте VPN/регион
Попробуйте отключить VPN
Или сменить VPN сервер
Уменьшите частоту запросов
# В config.yaml poll_seconds: 120  # Было 60, увеличили до 120
План Б: ручное закрытие
Если биржа не отвечает API — система НЕ СРАБОТАЕТ
Закройте позиции вручную через веб/мобильное приложение


### 35. Проблема: Закрылась только часть позиций

Признаки:
В логах: «Closed 3/5 positions» или «Sold 7/10 assets»
Часть позиций осталась открытой
Система пишет об ошибках на конкретных символах
Причины:
Минимальный notional не соблюдён (слишком маленький ордер)
Недостаточная ликвидность на рынке
Partial fill — биржа исполнила только часть ордера
Символ в maintenance mode
Delisting монеты
Решения:
Посмотрите что осталось
Зайдите на биржу и проверьте открытые позиции
Проверьте баланс спот активов
Проверьте логи на ошибки
# Ищем ошибки в выводе grep "Failed" killswitch.log grep "Error" killswitch.log
Дождитесь повторного срабатывания
Если cooldown истёк и просадка всё ещё есть
Система попытается закрыть остатки
Закройте вручную
Оставшиеся позиции лучше закрыть руками
Особенно если они маленькие (пыль)
Проверьте минимальные требования
У каждой биржи свой minimum order size
Binance: ~5-10 USDT, Bybit: ~5 USDT, Bitget: ~5 USDT


### 36. Проблема: Ложные срабатывания

Признаки:
Система срабатывает на обычной волатильности
Tier A активируется несколько раз в день
Закрываются позиции, хотя рынок быстро восстановился
Причины:
Слишком низкие пороги для данной волатильности
Недостаточное подтверждение (confirm_consecutive)
Слишком короткие временные окна
Шум в данных (проблемы API)
Решения:
Повысьте пороги
# Было tier_a:   thresholds: { "5": 0.015 }  # Стало tier_a:   thresholds: { "5": 0.025 }  # Увеличили на 1%
Увеличьте confirm_consecutive
# Было confirm_consecutive: 1  # Стало   confirm_consecutive: 3  # Требуем 3 минуты подтверждения
Удлините временные окна
# Было windows: [1, 5]  # Стало windows: [5, 15]  # Убрали 1-минутное окно
Увеличьте cooldown
Если срабатывает слишком часто
Увеличьте паузу до 90-120 минут для Tier A
Анализируйте историю
# Посмотрите просадки за прошлую неделю sqlite3 killswitch.sqlite " SELECT    MAX(equity) - MIN(equity) as drop,   (MAX(equity) - MIN(equity)) / MAX(equity) * 100 as drop_pct FROM snapshots WHERE ts > unixepoch('now') - 604800"


### 37. Проблема: Система не реагирует на падение

Признаки:
Рынок упал на 10%, но система молчит
Нет сообщений о срабатывании триггеров
Позиции не закрываются
Причины:
Слишком высокие пороги
Активна пауза (cooldown)
Недостаточно истории для расчёта
dry_run всё ещё включен
Проблемы с equity calculation
Диагностика:
Проверьте cooldown
sqlite3 killswitch.sqlite "SELECT * FROM cooldowns WHERE until > unixepoch('now')"
Если есть активные cooldown — система на паузе
Проверьте dry_run
grep "dry_run" config.yaml
Должно быть: dry_run: false
Проверьте equity
sqlite3 killswitch.sqlite "SELECT equity FROM snapshots ORDER BY ts DESC LIMIT 5"
Equity должна соответствовать реальному балансу
Если 0 или NaN — проблема с расчётом
Проверьте пороги
Рынок упал на 8%, а ваш порог tier_b = 15%
Снизьте пороги если они слишком высоки
Проверьте историю
sqlite3 killswitch.sqlite "SELECT COUNT(*) FROM snapshots"
Должно быть достаточно точек для расчёта DD
Минимум: 80% от window length


### 38. Bitget: специфичные проблемы

Bitget требует особого внимания из-за некоторых особенностей.
Проблема: System error without password
# Проверка echo $BITGET_PASSWORD  # Если пусто — экспортируйте export BITGET_PASSWORD="ваш_пароль_из_API_настроек"
Проблема: Нестабильный API
Bitget API менее стабилен чем Binance/Bybit:
Чаще возвращает ошибки
Вариативный формат ответов
Rate limits более строгие
Решения:
Увеличьте poll_seconds до 90-120 для Bitget
Чуть выше пороги чем на других биржах
Система имеет fallback parsing — должно работать
Проблема: Equity показывает неверное значение
Иногда Bitget возвращает equity в нестандартном формате:
Система пытается несколько вариантов парсинга
Проверьте логи на «Bitget equity parse attempt»
Если проблема повторяется — сообщите в issues


## IX. ЧАСТО ЗАДАВАЕМЫЕ ВОПРОСЫ


### 39. Установка и запуск

Q: Какая версия Python нужна?
A: Python 3.8 или новее. Проверьте: python3 --version

Q: API ключи не подхватываются?
A: Проверьте:
Переменные окружения экспортированы в той же сессии терминала
Названия переменных совпадают с config.yaml (BINANCE_API_KEY, не binance_api_key)
Нет лишних пробелов в значениях
# Проверка echo $BINANCE_API_KEY # Должно вывести ключ, не пусто

Q: Можно запустить на Windows?
A: Да, но рекомендуется Linux/Mac для стабильности. На Windows:
Используйте WSL (Windows Subsystem for Linux)
Или запускайте через PowerShell с корректными путями
Экспорт переменных: $env:BINANCE_API_KEY="..."

Q: Как запустить в фоне?
A: Используйте screen или tmux:
# Screen screen -S killswitch python3 killswitch.py --config config.yaml # Нажмите Ctrl+A, затем D для detach  # Вернуться к сессии screen -r killswitch  # Или tmux tmux new -s killswitch python3 killswitch.py --config config.yaml # Ctrl+B, затем D для detach


### 40. Безопасность

Q: Какие права должны быть у API ключей?
A: Минимально необходимые:
Read: информация о балансе и позициях
Trade: размещение и отмена ордеров
НЕ ДАВАТЬ: Withdraw (вывод средств), Transfer (переводы), Sub-accounts

Q: Можно ограничить по IP?
A: Да, рекомендуется:
На Binance: IP Access Restriction
На Bybit: IP Whitelist
На Bitget: API IP Whitelist
Укажите IP вашего сервера или домашний IP (если статический)

Q: Где хранить ключи?
A: В переменных окружения, НИКОГДА:
Не в коде скрипта
Не в config.yaml (используйте api_key_env)
Не в Git репозитории
Не в открытых файлах

Q: Что если ключи утекут?
A: Немедленно:
Отключите API ключи на бирже
Создайте новые ключи
Проверьте историю ордеров на подозрительную активность


### 41. Работа системы

Q: Как убедиться что dry-run ничего не торгует?
A: Проверьте историю ордеров на бирже:
Зайдите на биржу → Order History
За период работы dry-run не должно быть новых ордеров
В логах должно быть «DRY RUN: would execute...»

Q: Tier A и B могут сработать одновременно?
A: Да, у них независимые:
Пороги (tier_a.thresholds != tier_b.thresholds)
Cooldown (tier_a.cooldown_min != tier_b.cooldown_min)
Tier B может сработать пока Tier A на паузе, и наоборот

Q: Что если биржа в maintenance?
A: Система НЕ СМОЖЕТ торговать:
API биржи будет возвращать ошибки
Автоматика бессильна
Закрывайте позиции вручную через веб-интерфейс
Это критичное ограничение всех автоматических систем

Q: Сколько раз система повторяет попытку?
A: По умолчанию 3 попытки:
С экспоненциальной задержкой: 2с, 4с, 8с
Применяется к API запросам
Для critical операций (закрытие позиций)


### 42. Edge cases

Q: Монета делистнута с биржи?
A: Система пропустит её:
Не будет пары для продажи
В логах: «No route for COIN»
Закройте позицию вручную до delisting deadline

Q: Partial fill застрял?
A: Подождите или закройте вручную:
Система повторит при следующем срабатывании
Или закройте остаток руками
Проверьте минимальный order size биржи

Q: База данных SQLite заблокирована?
A: Редкая проблема:
WAL mode должен предотвращать блокировки
Не удаляйте базу во время работы
Не запускайте две копии скрипта одновременно

Q: Как вручную сбросить cooldown?
A: Через SQLite (см. раздел 32):
sqlite3 killswitch.sqlite "DELETE FROM cooldowns WHERE scope='binance_futures'"

Q: Можно изменить config.yaml на ходу?
A: Нет, нужен перезапуск:
Остановите скрипт (Ctrl+C)
Измените config.yaml
Перезапустите


## X. ПРИЛОЖЕНИЯ

Приложение A: Пример консервативного config.yaml
Полная конфигурация для защиты от сильных обвалов с минимумом ложных срабатываний.
# ============================================================================== # КОНСЕРВАТИВНАЯ КОНФИГУРАЦИЯ # ============================================================================== # Цель: защита от обвалов >10%, минимум ложных тревог # Подходит для: долгосрочных позиций, низкочастотной торговли  poll_seconds: 60 state_db: "./killswitch.sqlite" dry_run: true  # Переключите на false после тестирования stables_keep: ["USDT", "USDC", "DAI", "FDUSD"]  exchanges:   binance:     enabled: true     api_key_env: "BINANCE_API_KEY"     api_secret_env: "BINANCE_API_SECRET"          accounts:       futures:         enabled: true         windows: [15, 60]  # Средние и длинные окна                  tier_a:           thresholds:             "15": 0.040  # 4% за 15 минут             "60": 0.080  # 8% за час           confirm_consecutive: 3  # Строгое подтверждение           mode: "CLOSE_LONGS_ONLY"           cooldown_min: 90                  tier_b:           thresholds:             "15": 0.080  # 8% за 15 минут             "60": 0.150  # 15% за час           confirm_consecutive: 3           mode: "CLOSE_ALL_POSITIONS"           cooldown_min: 360  # 6 часов              spot:         enabled: true         windows: [60]                  tier_a:           thresholds: { "60": 0.12 }  # 12% за час           mode: "SELL_BLACKLIST_ONLY_KEEP_STABLES"           blacklist: ["DOGE", "SHIB"]  # Только мусор           cooldown_min: 120                  tier_b:           thresholds: { "60": 0.20 }  # 20% за час           mode: "SELL_ALL_NON_USDT_KEEP_STABLES"           cooldown_min: 480  # 8 часов    bybit:     enabled: true     api_key_env: "BYBIT_API_KEY"     api_secret_env: "BYBIT_API_SECRET"     # Аналогичные настройки...        bitget:     enabled: false  # Отключен для консервативной стратегии

Приложение B: Пример агрессивного config.yaml
Конфигурация для быстрой реакции на начало обвалов.
# ============================================================================== # АГРЕССИВНАЯ КОНФИГУРАЦИЯ # ============================================================================== # Цель: быстрый выход при первых признаках падения # Подходит для: активной торговли, высоколиквидных пар  poll_seconds: 30  # Чаще проверяем state_db: "./killswitch.sqlite" dry_run: true stables_keep: ["USDT", "USDC", "DAI"]  exchanges:   binance:     enabled: true     api_key_env: "BINANCE_API_KEY"     api_secret_env: "BINANCE_API_SECRET"          accounts:       futures:         enabled: true         windows: [1, 5, 15]  # Короткие окна                  tier_a:           thresholds:             "1": 0.015   # 1.5% за минуту             "5": 0.025   # 2.5% за 5 минут           confirm_consecutive: 1  # Моментальная реакция           mode: "CLOSE_LONGS_ONLY"           cooldown_min: 30  # Короткая пауза                  tier_b:           thresholds:             "5": 0.040   # 4% за 5 минут             "15": 0.060  # 6% за 15 минут           confirm_consecutive: 2           mode: "CLOSE_ALL_POSITIONS"           cooldown_min: 120              spot:         enabled: true         windows: [5, 15]                  tier_a:           thresholds: { "5": 0.04 }  # 4% за 5 минут           mode: "SELL_BLACKLIST_ONLY_KEEP_STABLES"           blacklist: ["DOGE", "SHIB", "PEPE", "BONK"]           cooldown_min: 30                  tier_b:           thresholds: { "15": 0.08 }  # 8% за 15 минут           mode: "SELL_ALL_NON_USDT_KEEP_STABLES"           cooldown_min: 180    # Все три биржи активны   bybit:     enabled: true     # ...        bitget:     enabled: true     # ...

Приложение C: Чек-лист перед запуском в LIVE
Убедитесь что выполнены все пункты перед переходом в боевой режим.
Pre-deployment
☐ Python 3.8+ установлен и работает
☐ Все библиотеки установлены (ccxt, pyyaml, tenacity)
☐ API ключи созданы с МИНИМАЛЬНЫМИ правами
☐ Переменные окружения экспортированы
☐ config.yaml настроен и проверен
Dry-run phase
☐ dry_run: true установлен
☐ Система работала минимум 24-48 часов без ошибок
☐ База данных накапливает историю (snapshots растут)
☐ Нет постоянных ошибок подключения к биржам
☐ Equity определяется корректно (не 0, не NaN)
☐ Решения принимаются адекватно (логи проверены)
☐ История ордеров на биржах пустая (ничего не торговалось)
LIVE transition
☐ Понимаете что будет делать Tier A и Tier B
☐ Начинаете с ОДНОГО scope (одна биржа, один тип счёта)
☐ Минимальный размер позиций на старте
☐ dry_run: false установлен ТОЛЬКО для тестового scope
☐ Есть план Б для ручного закрытия
☐ Доступ к веб/мобильному интерфейсу бирж
Post-deployment monitoring
☐ Настроен мониторинг логов
☐ Настроены алерты (Telegram/Email/Discord)
☐ Знаете как проверять SQLite базу
☐ Запланированы проверки каждые 4-6 часов первую неделю
☐ Знаете как остановить/перезапустить систему

Приложение D: Полезные команды
Коллекция команд для повседневного управления системой.
Управление процессом
# Запуск python3 killswitch.py --config config.yaml  # Запуск в фоне (screen) screen -S killswitch python3 killswitch.py --config config.yaml # Ctrl+A, D для detach  # Вернуться к сессии screen -r killswitch  # Список screen сессий screen -ls  # Остановка # Найдите процесс ps aux | grep killswitch # Убейте по PID kill <PID>
Просмотр истории
# Последние 20 снимков equity sqlite3 killswitch.sqlite " SELECT    datetime(ts, 'unixepoch', 'localtime') as time,   exchange,   account,   ROUND(equity, 2) as equity_usdt FROM snapshots  ORDER BY ts DESC  LIMIT 20"  # Equity график за последние 6 часов sqlite3 killswitch.sqlite " SELECT    strftime('%H:%M', datetime(ts, 'unixepoch', 'localtime')) as time,   ROUND(equity, 2) as equity FROM snapshots WHERE exchange='binance' AND account='futures'   AND ts > unixepoch('now') - 21600 ORDER BY ts ASC"
Сброс паузы (emergency)
# Посмотреть активные паузы sqlite3 killswitch.sqlite " SELECT    scope,   tier,   datetime(until, 'unixepoch', 'localtime') as expires FROM cooldowns WHERE until > unixepoch('now')"  # Сбросить для конкретного scope и tier sqlite3 killswitch.sqlite " DELETE FROM cooldowns  WHERE scope='binance_futures' AND tier='A'"  # Сбросить всё (ОПАСНО!) sqlite3 killswitch.sqlite "DELETE FROM cooldowns"
Backup базы данных
# Создать backup cp killswitch.sqlite killswitch.sqlite.backup_$(date +%Y%m%d_%H%M%S)  # Автоматический backup каждый день (добавьте в cron) 0 0 * * * cp /path/to/killswitch.sqlite /path/to/backups/killswitch_$(date +\%Y\%m\%d).sqlite

ЗАКЛЮЧЕНИЕ
Killswitch — это мощный инструмент автоматической защиты криптопортфеля, но помните:

Система работает лучше всего когда:
Правильно настроены пороги и временные окна
Установлен адекватный баланс между скоростью и точностью
Регулярно монитерится и корректируется
Используется как часть комплексной стратегии управления рисками

Удачи в защите вашего портфеля!


По всем вопросам и предложениям создавайте Issues в репозитории проекта.
